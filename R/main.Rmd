---
title: "BAG3 Co-IP MS Analysis"
author: "Emir Turkes"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
bibliography: "../bag3-co-ip.bib"
link-citations: true
output:
    html_document:
        number_sections: true
        theme: lumen
        toc: true
        toc_float:
            collapsed: false
            smooth_scroll: false
knit: (
    function(inputFile, encoding) {
        rmarkdown::render(
            inputFile,
            encoding = encoding,
            output_file = "../results/bag3-co-ip-analysis.html"
            )
        }
    )
---

```{r, include = FALSE}
# Copyright 2019 Emir Turkes
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

knitr::opts_chunk$set(echo = TRUE)

library("magrittr")

# TODO:
# Remove "docxtools" package.
```

<style type="text/css">

body{ /* Normal  */
  font-size: 16px;
}
h1.title {
  font-size: 35px;
}
h1 { /* Header 1 */
  font-size: 24px;
}
h2 { /* Header 2 */
  font-size: 22px;
}
h3 { /* Header 3 */
  font-size: 20px;
}
.toc-content {
  padding-left: 0px;
  padding-right: 0px;
}
div.tocify {
  width: 100%;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
  padding-left: 25px;
  text-indent: 0;
}
.tocify-subheader .tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 35px;
  text-indent: 0;
}
div.main-container {
  max-width: none;
  width: 100%;
}

</style>

*This is a broad initial analysis that prepares and characterizes the data for use in other projects.*

The background for this data is as follows:

- Co-IP MS (co-immunoprecipitation mass spectrometry) using BAG3 as bait.
- scrRNA control and shBAG3 to knockdown BAG3 for assessing BAG3 specific interactions.
- Approximately 90% efficient knockdown.
- Single replicate of mature rat primary cortical neurons (DIV 24).

# Final Results {-}

Read just this section for the final results of the analysis and a summary of the methods.

# Original Data {-}

This section contains the original data received from the mass spec facility and was mainly processed using Proteome Discoverer from Thermo Fisher.
The table below is unedited except for minimal formatting outside of R for easier import.

```{r, include = TRUE, echo = FALSE}
dt <- data.table::data.table(readxl::read_excel(
  "../proteome-discoverer/Ji_ProteinReport-ProteinReport_17-155-edited.xlsx"
))

# This should use eturkesRutils::datatable but the exponential conversion doesn't seem to work on this table.
# So, we recreate it excluding that feature.
DT::datatable(
    dt,
    extensions = "Buttons",
    options = list(
        dom = "Blfrtip",
        buttons = list(
            "copy", "print", list(
                extend = "collection", buttons = c(
                    "csv", "excel", "pdf"
                ),
                text = "Download"
            )
        )
    )
)
```

# Breakdown of Methods {-}

The following sections breakdown the methods used to transform the contents in "Original Data" to those in "Final Results".

# Preliminary Cleaning

First, we do some very basic modifications that improve presentation of the table without any data manipulation.
In best case scenarios, this may be all that is needed.

```{r, include = TRUE, echo = TRUE}
dt <- data.table::data.table(readxl::read_excel(
  "../proteome-discoverer/Ji_ProteinReport-ProteinReport_17-155-edited.xlsx"
))

# Rename and reduce columns.
cols <- c(
    "Genes",
    "Abundance Ratio: log2(scr/SH)",
    "scrRNA Abundance",
    "shBAG3 Abundance"
)
dt <- plyr::rename(dt, c(
    "Description" = cols[1],
    "Summed Abundance Ratio (log2): (Scr) / (SH)" = cols[2],
    "Scr Abundances" = cols[3],
    "SH Abundances" = cols[4]
    )
)
dt <- dt[, cols, with = FALSE]
dt[is.na(dt)] <- 0

# Extract gene names from the "Genes" column, removing entries that lack a name.
# This is only an intermediary step, the column of genes are then fed into IBM Watson and converted into Watson entities.
# The column of genes are then replaced with the Watson entities to facilitate easy comparison.
# This is done manually, as there is currently no Watson for Drug Discovery API.
dt[[cols[1]]] <- stringr::str_extract(dt[[cols[1]]], "(?<=GN=).*(?= PE=)")
dt <- dt[rowSums(is.na(dt[ , 1]))!=1, ]
watson_genes <- data.table::fread(
  "../watson/EntitySet_bag3-co-ip-basic-clean_2019-04-18_16-41-05.csv"
)
dt[[cols[1]]] <- watson_genes[["Entity name"]]

eturkesRutils::datatable(dt) %>%
    DT::formatStyle("Genes", `text-align` = "center")
```

## Sort Schemes {.tabset}

The above table does not appear to be sorted in any obvious way.
So, we explore sorting schemes most relevant to this dataset.
The schemes can be cycled through the tabs below.

### Specificity with BAG3

```{r, include = TRUE, echo = TRUE}
# Secondary sorted by "shBAG3 Abundance" ascending.
dt_spec <- dt[order(-dt[[cols[2]]], dt[[cols[4]]]), ]

eturkesRutils::datatable(dt_spec) %>%
    DT::formatStyle("Genes", `text-align` = "center")
```

### Abundance of Protein

```{r, include = TRUE, echo = TRUE}
# Secondary sorted by "shBAG3 Abundance" descending.
dt_abun <- dt[order(-dt[[cols[3]]], -dt[[cols[4]]]), ]

eturkesRutils::datatable(dt_abun) %>%
    DT::formatStyle("Genes", `text-align` = "center")
```

# Addressing Issues

The data wrangling thus far reveals several issues that we will attempt to tackle:

- Missing values in the "shBAG3 Abundance" column, which make true ratio calculations impossible.
- Maximum thresholds in the abundance ratio calculations, imposed by Proteome Discoverer for ratios above 100.
- log2 normalized abundance ratios, which complicate interpretation without added benefit due to the lack of negative ratios.
- Lack of hypothesis testing due to the lack of replicates required by Proteome Discoverer.

## Missing Value Imputation {.tabset}

There are a handful of methods for addressing missing values in metabolomics data, which were reviewed and compared in @wei_missing_2018.
The appropriate method is dependent on the type of missing value.
This set likely contains left-censored missing not at random (MNAR) values due to missing values only being present in the BAG3 KO condition.
Since the KO was 90% efficient, non-zero abundances that fall below the limits of quantification (LOQ) are expected.  

In their review, Wei et al. demonstrated QRILC (quantile regression imputation of left-censored data) to be the most performant method for this kind of data.
However, they have since published an original method called GSimp [@wei_gsimp:_2018], an iterative Gibbs sampler based left-censored missing value imputation approach, which outperformed previous benchmarks on several datasets.
Due to the recency of its publication, we will benchmark the two techniques, along with the far simplier but still useful HM (half-minimum) technique.

```{r, include = TRUE, echo = TRUE}
# Data must be made "tidy".
cols_mvi <- cols[cols != cols[2]]
dt_mvi <- dt[, cols_mvi, with = FALSE]
dt_mvi[dt_mvi == 0] <- NA
dt_mvi <- reshape2::melt(dt_mvi, id = cols[1], variable.name = "group")
dt_mvi <- tidyr::spread(dt_mvi, cols[1], "value")
```

### GSimp

```{r, include = TRUE, echo = TRUE}
#options(stringsAsFactors = FALSE)
#source("../GSimp/Trunc_KNN/Imput_funcs.r")
#source("../GSimp/GSimp_evaluation.R")
#source("../Gsimp/GSimp.R")
```

### QRILC

### HM

## Removal of Maximum Threshold

## Renormalization

## Hypothesis Testing

# Session Info

```{r, include = TRUE, echo = TRUE}
devtools::session_info()
```

# References
